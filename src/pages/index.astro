---
import Database from 'better-sqlite3';
import path from 'path';
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';

const dbPath = path.resolve('content.db');
const db = new Database(dbPath);

const ITEMS_PER_PAGE = 12;
const currentPage = parseInt(Astro.url.searchParams.get('page')) || 1;
const offset = (currentPage - 1) * ITEMS_PER_PAGE;

let articles = [];
let totalArticles = 0;

try {
  articles = db.prepare(`SELECT * FROM articles ORDER BY id DESC LIMIT ? OFFSET ?`).all(ITEMS_PER_PAGE, offset);
  totalArticles = db.prepare("SELECT COUNT(*) AS count FROM articles").get().count;
} catch (e) {
  console.error("❌ DB Error:", e);
} finally {
  db.close();
}

const totalPages = Math.ceil(totalArticles / ITEMS_PER_PAGE) || 1;
---

<BaseLayout title="Technical Pulse | 2026 Insights">
  <Header />
  <main class="container">
    <div class="hero">
      <span class="label">Verified Intelligence</span>
      <h1>The 2026 Technical Pulse</h1>
      <p>Deciphering hardware breakthroughs and AI innovations with multi-source verified reviews.</p>
    </div>

    <div class="bento-grid">
      {articles.map((post, index) => (
        <a href={`/knownow/article/${post.slug}/`} class="bento-card">
          <div class="media-box">
            <img src={post.image_url || '/placeholder.png'} alt={post.title} loading={index < 3 ? "eager" : "lazy"} />
            <div class="overlay-badge">{post.category || 'Tech'}</div>
          </div>
          <div class="text-box">
            <h2>{post.title}</h2>
            <div class="footer-meta">
              <span class="action">Analysis →</span>
              <span>{new Date(post.created_at).toLocaleDateString()}</span>
            </div>
          </div>
        </a>
      ))}
    </div>

    {totalArticles > ITEMS_PER_PAGE && (
      <nav class="pagination">
        <a href={`/knownow/?page=${currentPage - 1}`} class={currentPage === 1 ? 'disabled' : ''}>Prev</a>
        <span>{currentPage} / {totalPages}</span>
        <a href={`/knownow/?page=${currentPage + 1}`} class={currentPage === totalPages ? 'disabled' : ''}>Next</a>
      </nav>
    )}
  </main>
</BaseLayout>

<style>
  .container { max-width: 1250px; margin: 0 auto; padding: 5rem 1.5rem; }
  .hero { text-align: center; margin-bottom: 7rem; }
  .label { color: #0070f3; font-weight: 800; text-transform: uppercase; letter-spacing: 0.2em; font-size: 0.75rem; }
  h1 { font-size: clamp(3rem, 8vw, 5.5rem); font-weight: 900; letter-spacing: -0.06em; margin: 1rem 0; }
  
  .bento-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 3rem; }
  .bento-card { background: #fff; border-radius: 32px; border: 1px solid #f0f0f0; text-decoration: none; color: inherit; transition: 0.4s cubic-bezier(0.2, 1, 0.3, 1); }
  .bento-card:hover { transform: translateY(-12px); border-color: #0070f3; box-shadow: 0 40px 80px rgba(0,0,0,0.08); }
  
  .media-box { position: relative; aspect-ratio: 16/10; overflow: hidden; border-radius: 32px 32px 0 0; }
  .media-box img { width: 100%; height: 100%; object-fit: cover; transition: 0.6s; }
  .bento-card:hover img { scale: 1.05; }
  .overlay-badge { position: absolute; bottom: 1rem; left: 1rem; background: white; padding: 6px 14px; border-radius: 50px; font-weight: 800; font-size: 0.65rem; color: #111; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

  .text-box { padding: 2.5rem; }
  h2 { font-size: 1.6rem; font-weight: 800; line-height: 1.2; margin-bottom: 2rem; }
  .footer-meta { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f5f5f5; padding-top: 1.5rem; font-size: 0.85rem; font-weight: 600; }
  .action { color: #0070f3; }
  
  .pagination { display: flex; justify-content: center; align-items: center; margin-top: 6rem; gap: 2rem; }
  .pagination a { padding: 12px 25px; background: #0070f3; color: white; border-radius: 12px; text-decoration: none; font-weight: 700; }
  .disabled { opacity: 0.3; pointer-events: none; }
</style>