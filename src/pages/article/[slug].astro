---
import { createClient } from "@libsql/client";

// CLOUDFLARE BUILD FIX: 
// We must ensure these are strings and provide a fallback to prevent 'undefined' crash
const url = (import.meta.env.TURSO_DATABASE_URL || process.env.TURSO_DATABASE_URL || "").trim();
const authToken = (import.meta.env.TURSO_AUTH_TOKEN || process.env.TURSO_AUTH_TOKEN || "").trim();

export async function getStaticPaths() {
  const url = (import.meta.env.TURSO_DATABASE_URL || process.env.TURSO_DATABASE_URL || "").trim();
  const authToken = (import.meta.env.TURSO_AUTH_TOKEN || process.env.TURSO_AUTH_TOKEN || "").trim();

  // If both are missing, return empty to prevent the 'URL_INVALID' crash
  if (!url) {
    console.error("❌ CRITICAL: TURSO_DATABASE_URL is missing in build environment!");
    return [];
  }

  const buildClient = createClient({ url, authToken });

  try {
    const rs = await buildClient.execute("SELECT slug FROM articles WHERE slug IS NOT NULL");
    return rs.rows.map((row) => ({ params: { slug: row.slug } }));
  } catch (e) {
    console.error("Database fetch failed:", e);
    return [];
  }
}

const { slug } = Astro.params;
let post = { title: "Loading...", content: "", image_url: "" };

if (url && slug) {
    const client = createClient({ url, authToken });
    const rs = await client.execute({
        sql: "SELECT * FROM articles WHERE slug = ?",
        args: [slug]
    });
    post = rs.rows[0] || post;
}
---

<article style="max-width: 750px; margin: 4rem auto; padding: 0 1.5rem; line-height: 1.8; font-family: 'Inter', sans-serif;">
  <a href="/" style="text-decoration: none; color: #666;">← Back to Pulse</a>
  <img src={post.image_url as string} style="width: 100%; border-radius: 16px; margin: 2rem 0;" />
  <h1 style="font-size: 2.5rem; line-height: 1.2; margin-bottom: 2rem;">{post.title}</h1>
  <div set:html={post.content} class="prose" />
</article>