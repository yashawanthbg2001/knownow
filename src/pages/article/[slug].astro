---
import Database from 'better-sqlite3';
import path from 'path';
import BaseLayout from '../../layouts/BaseLayout.astro';

// Fetch article data based on the slug
export async function getStaticPaths() {
  const dbPath = path.resolve('content.db');
  const db = new Database(dbPath);

  // Get all slugs from the database
  const rows = db.prepare("SELECT slug FROM articles WHERE slug IS NOT NULL").all();

  // Ensure we have valid slugs; otherwise, warn during build
  if (!rows || rows.length === 0) {
    console.warn("[Warning] No valid slugs found in the database.");
    return [];
  }

  return rows.map((row) => ({ params: { slug: String(row.slug) } }));
}

// Get data for the requested slug
const { slug } = Astro.params;
const dbPath = path.resolve('content.db');
const db = new Database(dbPath);
const post = db.prepare("SELECT * FROM articles WHERE slug = ?").get(slug);

// Handle missing posts
if (!post) {
  console.error(`[Error] No post found for slug: "${slug}"`);
  throw new Error(`No post found for slug: "${slug}" - Ensure your database contains the entry.`);
}

// Safeguard article content and other fields
const postContent = post.content || ""; // Default to empty content
const seoDescription = post?.content
  ? post.content.replace(/<[^>]*>/g, '').substring(0, 155) + "..."
  : "Read the latest on cutting-edge tech in KnowNow.";
const postTitle = post?.title || "Article Not Found";
const postImage = post?.image_url || '/placeholder-image.png'; // Default image placeholder
---

<BaseLayout 
  title={postTitle} 
  description={seoDescription} 
  slug={slug}
  image={postImage}
>
  <article style="max-width: 750px; margin: 4rem auto; padding: 0 1.5rem; line-height: 1.8; font-family: 'Inter', sans-serif;">
    
    <!-- Back Navigation -->
    <a href="/knownow/" style="text-decoration: none; color: #0070f3; font-weight: bold;">← Back to Pulse</a>

    <!-- Metadata -->
    <div style="margin-top: 2rem; color: #666; font-size: 0.9rem;">
      ⏱ {Math.ceil((post.word_count || 500) / 200)} min read • Published on {new Date(post.created_at).toLocaleDateString()}
    </div>

    <!-- Article Image -->
    {postImage && (
      <img src={postImage} style="width: 100%; border-radius: 16px; margin: 2rem 0; box-shadow: 0 10px 30px rgba(0,0,0,0.1);" alt={postTitle} />
    )}

    <!-- Title -->
    <h1 style="font-size: 3rem; line-height: 1.1; margin-bottom: 2rem; letter-spacing: -0.02em;">{postTitle}</h1>
    
    <!-- Verdict Box -->
    {postContent.match(/<div class="verdict-box">([\s\S]+?)<\/div>/) && (
      <div class="verdict-box" 
           set:html={postContent.match(/<div class="verdict-box">([\s\S]+?)<\/div>/)[0]} 
           style="background: #f9f9f9; border-left: 6px solid #0070f3; padding: 1.5rem; margin-bottom: 2rem; border-radius: 12px; line-height: 1.6;" />
    )}

    <!-- Pros/Cons Section -->
    {postContent.match(/<ul class="pros-cons">([\s\S]+?)<\/ul>/) && (
      <section style="margin-bottom: 2rem;">
        <h2>Pros & Cons</h2>
        <div set:html={postContent.match(/<ul class="pros-cons">([\s\S]+?)<\/ul>/)[0]} />
      </section>
    )}

    <!-- Additional Sections -->
    {postContent.match(/<div class="performance-section">([\s\S]+?)<\/div>/) && (
      <section style="margin-bottom: 2rem;">
        <h2>Real-World Performance</h2>
        <div set:html={postContent.match(/<div class="performance-section">([\s\S]+?)<\/div>/)[0]} />
      </section>
    )}

    {postContent.match(/<div class="key-specs">([\s\S]+?)<\/div>/) && (
      <section style="margin-bottom: 2rem;">
        <h2>Key Specs</h2>
        <div set:html={postContent.match(/<div class="key-specs">([\s\S]+?)<\/div>/)[0]} />
      </section>
    )}

    {postContent.match(/<div class="pain-points">([\s\S]+?)<\/div>/) && (
      <section style="margin-bottom: 2rem;">
        <h2>Pain Points & FAQs</h2>
        <div set:html={postContent.match(/<div class="pain-points">([\s\S]+?)<\/div>/)[0]} />
      </section>
    )}

    <!-- Remaining Content -->
    <section class="article-content prose" style="margin-bottom: 2rem;">
      <div set:html={postContent.replace(/<div class="verdict-box">([\s\S]+?)<\/div>/, '')  // Remove Verdict
                                 .replace(/<ul class="pros-cons">([\s\S]+?)<\/ul>/, '')        // Remove Pros/Cons
                                 .replace(/<div class="performance-section">([\s\S]+?)<\/div>/, '') // Remove Performance
                                 .replace(/<div class="key-specs">([\s\S]+?)<\/div>/, '')      // Remove Specs
                                 .replace(/<div class="pain-points">([\s\S]+?)<\/div>/, '')} />
    </section>
    
  </article>
</BaseLayout>