---
import Database from 'better-sqlite3';
import path from 'path';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const dbPath = path.resolve('content.db');
  const db = new Database(dbPath);
  const posts = db.prepare("SELECT * FROM articles WHERE slug IS NOT NULL").all();
  db.close();

  if (!posts || posts.length === 0) return [];

  return posts.map((post) => ({
    params: { slug: String(post.slug) },
    props: { post },
  }));
}

const { post } = Astro.props;
const { slug } = Astro.params;

if (!post) return Astro.redirect('/404');

const postContent = post.content || "";
const postTitle = post.title || "Technical Review";
const postImage = post.image_url || '/placeholder-image.png';

const seoDescription = postContent
  ? postContent.replace(/<[^>]*>/g, '').substring(0, 155) + "..."
  : "Expert tech analysis on KnowNow.";

// Section Extractors
const extract = (regex) => {
  const match = postContent.match(regex);
  return match ? match[0] : null;
};

const verdictRegex = /<div class="verdict-box">([\s\S]+?)<\/div>/;
const specsRegex = /<table class="spec-table">([\s\S]+?)<\/table>/;
const faqRegex = /<details class="faq-item">([\s\S]+?)<\/details>/g; // Match all FAQs

const verdictHtml = extract(verdictRegex);
const specsHtml = extract(specsRegex);
---

<BaseLayout
  post={post} 
  title={postTitle} 
  description={seoDescription} 
  slug={slug}
  image={postImage}
>
  <article class="review-container">
    <nav class="top-nav">
      <a href="/knownow/">‚Üê Back to Technical Pulse</a>
    </nav>

    <header class="hero-header">
      <div class="badge-row">
        <span class="category-badge">{post.category || 'Hardware'}</span>
        {post.tier && <span class="tier-badge">Tier {post.tier}</span>}
      </div>
      <h1>{postTitle}</h1>
      <div class="meta-line">
        <time>{new Date(post.created_at).toLocaleDateString('en-US', {month: 'long', day: 'numeric', year: 'numeric'})}</time>
        <span class="separator">‚Ä¢</span>
        <span>{Math.ceil((post.word_count || 500) / 200)} min read</span>
      </div>
    </header>

    <div class="main-visual">
      <img src={postImage} alt={postTitle} loading="eager" />
    </div>

    {verdictHtml && (
      <section class="verdict-wrapper" set:html={verdictHtml} />
    )}

    <div class="content-body">
       <div set:html={postContent
          .replace(verdictRegex, '')
          .replace(specsRegex, '')
        } />
    </div>

    {specsHtml && (
      <section class="specs-section">
        <h2 class="section-heading">Technical Specifications</h2>
        <div class="table-scroll" set:html={specsHtml} />
      </section>
    )}

    <footer class="source-footer">
      <p>Source Data: <a href={post.source_url} target="_blank">Official Documentation</a></p>
    </footer>
  </article>
</BaseLayout>

<style is:global>
  /* Base Layout & Typography */
  .review-container { max-width: 800px; margin: 0 auto; padding: 2rem 1.5rem; color: #1a1a1a; }
  .top-nav { margin-bottom: 2rem; }
  .top-nav a { color: #0070f3; text-decoration: none; font-weight: 600; font-size: 0.9rem; }

  /* Badges */
  .badge-row { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
  .category-badge { background: #0070f3; color: white; padding: 4px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
  .tier-badge { background: #f0f0f0; color: #666; padding: 4px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 700; }

  /* Headings */
  h1 { font-size: clamp(2.5rem, 6vw, 4rem); line-height: 1.05; letter-spacing: -0.04em; margin-bottom: 1.5rem; font-weight: 900; }
  h2 { font-size: 2rem; margin-top: 3rem; margin-bottom: 1.25rem; font-weight: 800; border-bottom: 2px solid #eee; padding-bottom: 0.5rem; }
  
  .meta-line { color: #666; font-size: 0.95rem; margin-bottom: 3rem; }

  /* Visuals */
  .main-visual img { width: 100%; height: auto; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15); margin-bottom: 4rem; }

  /* üü¢ Verdict Box Styling */
  .verdict-box { background: #f8fbff; border: 1px solid #dbeafe; border-radius: 20px; padding: 2.5rem; margin-bottom: 4rem; }
  .verdict-box h2 { border: none; color: #0070f3; margin-top: 0; font-size: 1.5rem; }
  .verdict-box ul { list-style: none; padding: 0; }
  .verdict-box li { position: relative; padding-left: 1.5rem; margin-bottom: 0.75rem; }
  .verdict-box li::before { content: "‚Üí"; position: absolute; left: 0; color: #0070f3; font-weight: bold; }

  /* üü¢ FAQ Accordion Styling (details/summary) */
  details.faq-item { background: #fff; border: 1px solid #eee; border-radius: 12px; margin-bottom: 1rem; transition: 0.3s; }
  details.faq-item[open] { border-color: #0070f3; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); }
  summary { padding: 1.25rem; cursor: pointer; font-weight: 700; list-style: none; position: relative; }
  summary::-webkit-details-marker { display: none; }
  summary::after { content: "+"; float: right; color: #0070f3; font-size: 1.2rem; }
  details[open] summary::after { content: "‚àí"; }
  .faq-answer { padding: 0 1.25rem 1.25rem; color: #444; line-height: 1.6; }

  /* üü¢ Table Styling */
  .table-scroll { overflow-x: auto; }
  table.spec-table { width: 100%; border-collapse: collapse; margin: 2rem 0; font-size: 0.95rem; }
  table.spec-table th, table.spec-table td { text-align: left; padding: 1rem; border-bottom: 1px solid #f0f0f0; }
  table.spec-table th { background: #fafafa; color: #666; width: 35%; font-weight: 600; }

  /* General Text */
  p { margin-bottom: 1.5rem; font-size: 1.15rem; color: #333; }
  .source-footer { margin-top: 6rem; border-top: 1px solid #eee; padding-top: 2rem; font-size: 0.9rem; color: #999; }
</style>