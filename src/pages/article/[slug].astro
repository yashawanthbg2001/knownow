---
import { createClient } from "@libsql/client";

export async function getStaticPaths() {
  const DB_URL = import.meta.env.PUBLIC_TURSO_DATABASE_URL?.trim() ?? "";
  const DB_TOKEN = import.meta.env.PUBLIC_TURSO_AUTH_TOKEN?.trim() ?? "";

  if (!DB_URL) {
    console.error("❌ TURSO DATABASE URL MISSING AT BUILD TIME");
    return [];
  }

  const client = createClient({
    url: DB_URL,
    authToken: DB_TOKEN,
  });

  try {
    const rs = await client.execute(
      "SELECT slug FROM articles WHERE slug IS NOT NULL"
    );

    return rs.rows.map((row) => ({
      params: { slug: row.slug },
    }));
  } catch (e) {
    console.error("❌ Database fetch failed:", e);
    return [];
  }
}

// ⬇️ normal page code (runs AFTER paths are known)
const DB_URL = import.meta.env.PUBLIC_TURSO_DATABASE_URL?.trim() ?? "";
const DB_TOKEN = import.meta.env.PUBLIC_TURSO_AUTH_TOKEN?.trim() ?? "";

const { slug } = Astro.params;

let post = {
  title: "Not found",
  content: "",
  image_url: "",
};

if (DB_URL && slug) {
  const client = createClient({
    url: DB_URL,
    authToken: DB_TOKEN,
  });

  const rs = await client.execute({
    sql: "SELECT * FROM articles WHERE slug = ?",
    args: [slug],
  });

  post = rs.rows[0] ?? post;
}
---


<article style="max-width: 750px; margin: 4rem auto; padding: 0 1.5rem; line-height: 1.8; font-family: 'Inter', sans-serif;">
  <a href="/" style="text-decoration: none; color: #666;">← Back to Pulse</a>
  <img src={post.image_url as string} style="width: 100%; border-radius: 16px; margin: 2rem 0;" />
  <h1 style="font-size: 2.5rem; line-height: 1.2; margin-bottom: 2rem;">{post.title}</h1>
  <div set:html={post.content} class="prose" />
</article>