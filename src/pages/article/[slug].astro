---
import Database from 'better-sqlite3';
import path from 'path';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';

export async function getStaticPaths() {
  const dbPath = path.resolve('content.db');
  const db = new Database(dbPath);
  const posts = db.prepare("SELECT * FROM articles WHERE slug IS NOT NULL").all();
  db.close();
  return posts.map((post) => ({ params: { slug: String(post.slug) }, props: { post } }));
}

const { post } = Astro.props;
const postContent = post.content || "";
const postTitle = post.title || "Technical Review";
const postImage = post.image_url || '/placeholder.png';

const extract = (regex) => {
  const match = postContent.match(regex);
  return match ? match[0] : null;
};

const verdictRegex = /<div class="verdict-box">([\s\S]+?)<\/div>/;
const specsRegex = /<table class="spec-table">([\s\S]+?)<\/table>/;
const schemaRegex = /<script type="application\/ld\+json">([\s\S]+?)<\/script>/;

const verdictHtml = extract(verdictRegex);
const specsHtml = extract(specsRegex);
const schemaHtml = extract(schemaRegex);
---

<BaseLayout post={post} title={postTitle} image={postImage}>
  {schemaHtml && <Fragment set:html={schemaHtml} slot="head" />}
  <Header />

  <article class="article-container">
    <nav class="breadcrumb">
      <a href="/knownow/">‚Üê Back to Technical Pulse</a>
    </nav>

    <header class="post-header">
      <div class="badges">
        <span class="cat">{post.category}</span>
        {post.tier && <span class="tier">Tier {post.tier} Verified</span>}
      </div>
      <h1>{postTitle}</h1>
      <div class="author-info">
        <div class="bot-avatar">K</div>
        <div>
          <strong>KnowNow Research Bot</strong>
          <span>Published {new Date(post.created_at).toDateString()}</span>
        </div>
      </div>
    </header>

    <div class="hero-image">
      <img src={postImage} alt={postTitle} />
    </div>

    <div class="entry-content">
      {verdictHtml && <div class="v-wrapper" set:html={verdictHtml} />}
      
      <div class="body-copy" set:html={postContent.replace(verdictRegex, '').replace(specsRegex, '').replace(schemaRegex, '')} />

      {specsHtml && (
        <section class="specs-box">
          <h2>Technical Architecture</h2>
          <div class="table-scroll" set:html={specsHtml} />
        </section>
      )}
    </div>

    <footer class="legal-footer">
      <div class="disclaimer">
        <h3>üõ°Ô∏è Safety & Accuracy Disclaimer</h3>
        <p>
          This content was synthesized using KnowNow's multi-source technical engine. While we prioritize 
          official documentation and verified repositories, 2026 hardware and software specifications are 
          subject to regional variations and firmware updates. Information provided is for educational 
          and analysis purposes only.
        </p>
      </div>
      <div class="source-credit">
        Original Research Source: <a href={post.source_url} target="_blank">{post.source_url}</a>
      </div>
    </footer>
  </article>
</BaseLayout>

<style is:global>
  .article-container { max-width: 820px; margin: 0 auto; padding: 4rem 1.5rem; }
  .breadcrumb a { color: #0070f3; text-decoration: none; font-weight: 700; font-size: 0.85rem; }
  
  .post-header { text-align: center; margin: 3rem 0; }
  .badges { display: flex; gap: 0.8rem; justify-content: center; margin-bottom: 1.5rem; }
  .cat { background: #0070f3; color: white; padding: 5px 15px; border-radius: 50px; font-weight: 800; font-size: 0.7rem; text-transform: uppercase; }
  .tier { background: #f5f5f5; color: #666; padding: 5px 15px; border-radius: 50px; font-weight: 700; font-size: 0.7rem; }
  
  h1 { font-size: clamp(2.8rem, 7vw, 4.5rem); line-height: 1.1; font-weight: 900; letter-spacing: -0.05em; }
  
  .author-info { display: flex; align-items: center; justify-content: center; gap: 1rem; margin-top: 2rem; }
  .bot-avatar { width: 40px; height: 40px; background: #0070f3; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; }
  .author-info span { display: block; font-size: 0.8rem; color: #999; }

  .hero-image img { width: 100%; border-radius: 32px; box-shadow: 0 40px 80px rgba(0,0,0,0.1); margin: 4rem 0; }

  .v-wrapper { background: #f0f7ff; border-left: 6px solid #0070f3; border-radius: 16px; padding: 2.5rem; margin-bottom: 4rem; }
  .v-wrapper h2 { border: none; margin: 0 0 1rem; font-size: 1.4rem; color: #0070f3; }

  .body-copy { font-size: 1.25rem; line-height: 1.85; color: #222; }
  .body-copy h2 { font-size: 2rem; margin: 4rem 0 1.5rem; font-weight: 800; }

  .specs-box { background: #fafafa; border-radius: 24px; padding: 3rem; margin-top: 5rem; }
  .specs-box h2 { border: none; margin-top: 0; }

  .legal-footer { margin-top: 8rem; border-top: 1px solid #eee; padding-top: 3rem; }
  .disclaimer { background: #fdfdfd; border: 1px solid #eee; padding: 2rem; border-radius: 16px; font-size: 0.95rem; color: #777; line-height: 1.6; }
  .disclaimer h3 { font-size: 1.1rem; color: #111; margin-bottom: 1rem; }
  .source-credit { margin-top: 1.5rem; font-weight: 700; font-size: 0.85rem; color: #999; }
</style>